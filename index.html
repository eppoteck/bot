<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover" />
  <title>Lisa â€” Asisten Informasi</title>
  <style>
    :root{
      --bg:#f2f6fb; --card:#ffffff; --primary:#0b63d6; --muted:#7a8aa6;
      --bot-bg:#f1f4f8; --user-bg:#e6f0ff;
      --header-h:72px; --footer-h:68px; --max-w:820px;
    }

    /* page */
    html,body{height:100%; margin:0; background:var(--bg); font-family:Inter,Segoe UI,Roboto,Arial; color:#0b2b45; -webkit-font-smoothing:antialiased}
    .wrap{min-height:100vh; display:flex; align-items:center; justify-content:center; padding:12px; box-sizing:border-box}

    /* chat shell: use full available height so sticky header/footer work on mobile */
    .chat{
      width:100%;
      max-width:var(--max-w);
      height:calc(100vh - 24px);
      display:flex;
      flex-direction:column;
      background:linear-gradient(180deg,var(--card),#fbfdff);
      border-radius:16px;
      box-shadow:0 10px 30px rgba(3,20,45,.08);
      overflow:hidden;
      border:1px solid rgba(11,99,214,0.06);
    }

    /* header (sticky) */
    .header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:12px 14px;
      background:linear-gradient(90deg,var(--primary),#0a56c0);
      color:#fff;
      position:sticky;
      top:0;
      z-index:5;
      min-height:var(--header-h);
      box-sizing:border-box;
      flex-wrap:wrap;
    }
    .brand{display:flex; gap:12px; align-items:center; min-width:0}
    .logo{width:44px;height:44px;border-radius:10px;background:rgba(255,255,255,0.12);display:flex;align-items:center;justify-content:center;font-weight:700;font-size:18px;flex:0 0 auto}
    .title{font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .subtitle{font-size:12px; opacity:.95; color:rgba(255,255,255,0.95); white-space:nowrap; overflow:hidden; text-overflow:ellipsis}

    .controls{display:flex; gap:8px; align-items:center; flex:0 0 auto; max-width:50%}
    .mute{background:rgba(255,255,255,0.12); padding:8px 10px; border-radius:8px; color:#fff; cursor:pointer; border:1px solid rgba(255,255,255,0.08)}
    select#voiceSelect{background:transparent;color:#fff;border:none;outline:none;padding:6px;border-radius:6px; min-width:160px}
    select#voiceSelect, select#voiceSelect option { color:#fff; -webkit-text-fill-color:#fff; }

    /* messages: flexible area */
    .messages{
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:12px;
      overflow:auto;
      background:linear-gradient(180deg,#fff,#f7fbff);
      flex:1 1 auto;
      -webkit-overflow-scrolling:touch;
    }
    .msg{max-width:86%; padding:10px 12px; border-radius:12px; line-height:1.35; word-break:break-word}
    .bot{align-self:flex-start; background:var(--bot-bg); color:#07203b}
    .user{align-self:flex-end; background:var(--user-bg); color:#032b57}
    .meta{font-size:11px;color:var(--muted);margin-top:6px}

    /* footer (sticky) */
    .footer{
      padding:10px;
      display:flex;
      gap:8px;
      align-items:center;
      border-top:1px solid rgba(10,20,40,0.04);
      background:linear-gradient(180deg,transparent,rgba(250,252,255,0.6));
      position:sticky;
      bottom:0;
      z-index:6;
      box-sizing:border-box;
      min-height:var(--footer-h);
    }
    .inputWrap{display:flex;gap:8px;flex:1;align-items:center; min-width:0}
    input[type="text"]{flex:1;padding:12px 14px;border-radius:10px;border:1px solid #e4ecf8;background:#fff;font-size:15px;outline:none;box-shadow:inset 0 1px 0 rgba(10,20,40,0.02);min-width:0}
    button.send{background:var(--primary);color:#fff;border:none;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600;flex:0 0 auto}

    /* quick suggestions */
    .suggest{margin-top:6px;font-size:0.95em;color:#415a75}
    .quick{background:#eef6ff;border:1px solid #cfe6ff;color:var(--primary);padding:6px 8px;border-radius:6px;margin:6px 6px 0 0;cursor:pointer;font-size:13px}

    /* responsive tweaks */
    @media (max-width:600px){
      .chat{height:100vh; border-radius:12px}
      .header{padding:10px; gap:8px; align-items:flex-start}
      .brand{width:100%; gap:10px}
      .controls{width:100%; justify-content:space-between; gap:8px; margin-top:6px; flex-wrap:wrap}
      select#voiceSelect{min-width:0; width:48%}
      .messages{padding:10px; gap:10px}
      .footer{padding:8px}
      input[type="text"]{padding:10px}
      .quick{font-size:12px;padding:6px}
    }

    /* accessibility */
    button:focus, select:focus, input:focus { outline:3px solid rgba(11,99,214,0.18); outline-offset:2px; }
  </style>
</head>
<body>
  <div class="wrap">
    <main class="chat" role="application" aria-label="Lisa - Asisten Informasi">
      <header class="header">
        <div class="brand">
          <div class="logo" aria-hidden="true">L</div>
          <div style="min-width:0">
            <div class="title">Lisa â€” Asisten Informasi</div>
            <div class="subtitle">KTP â€¢ KK â€¢ SIM â€¢ BPJS â€¢ Nikah â€¢ Cerai</div>
          </div>
        </div>

        <div class="controls" aria-hidden="false">
          <button id="voiceToggle" class="mute" title="Suara: aktif/nonaktif">ðŸ”Š</button>
          <select id="voiceSelect" aria-label="Pilih suara" title="Pilih suara"><option>Memuat suara ID...</option></select>
        </div>
      </header>

      <section id="messages" class="messages" aria-live="polite"></section>

      <form id="form" class="footer" onsubmit="return false;">
        <div class="inputWrap">
          <input id="input" type="text" placeholder="Tanya: syarat KTP, cara buat SIM, info BPJS, nikah, cerai..." autocomplete="off" />
        </div>
        <button id="send" class="send" aria-label="Kirim pesan">Kirim</button>
      </form>
    </main>
  </div>

  <script>
    // minimal adjustments: auto-scroll on focus, keep previous TTS logic
    const messagesEl = document.getElementById('messages');
    const inputEl = document.getElementById('input');
    const sendBtn = document.getElementById('send');
    const voiceToggle = document.getElementById('voiceToggle');
    const voiceSelect = document.getElementById('voiceSelect');

    function escapeHtml(s){ return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
    function stripHtml(html){ const tmp = document.createElement('div'); tmp.innerHTML = html; return tmp.textContent || tmp.innerText || ''; }

    function appendMessage(html, who='bot'){
      const div = document.createElement('div');
      div.className = 'msg ' + (who==='user' ? 'user' : 'bot');
      div.innerHTML = html;
      messagesEl.appendChild(div);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    // basic KB + botReply (kept simple)
    const kb = {
      ktp:{title:'Membuat KTP', text:'Syarat umum: membawa KK, akta kelahiran, fotokopi. Daftar di Dukcapil.' , link:{url:'https://www.dukcapil.kemendagri.go.id/', label:'Info Dukcapil'}},
      kk:{title:'Membuat/Mengurus KK', text:'Perubahan/penerbitan KK: dokumen anggota keluarga, lapor ke Dukcapil.' , link:{url:'https://www.dukcapil.kemendagri.go.id/', label:'Info Dukcapil'}},
      sim:{title:'Membuat SIM', text:'Persyaratan: fotokopi KTP, tes kesehatan, ujian teori & praktik.' , link:{url:'https://sim.korlantas.polri.go.id/', label:'Info SIM Korlantas'}},
      bpjs:{title:'BPJS Kesehatan', text:'Daftar online/ke kantor BPJS. Persyaratan: KTP, KK.' , link:{url:'https://www.bpjs-kesehatan.go.id/', label:'Info BPJS Kesehatan'}},
      nikah:{title:'Pendaftaran Nikah', text:'Untuk muslim daftar di KUA; non-muslim di catatan sipil. Persyaratan: KTP, KK, akta kelahiran.' , link:{url:'https://kemenag.go.id/', label:'Kementerian Agama'}},
      cerai:{title:'Perceraian', text:'Ajukan ke Pengadilan Agama (muslim) atau Pengadilan Negeri (non-muslim). Dokumen: akta nikah, KTP.' , link:{url:'https://www.mahkamahagung.go.id/', label:'Info Pengadilan'}}
    };

    function formatKB(item){ return '<strong>'+item.title+'</strong><br>'+item.text+'<br><a class="link" href="'+item.link.url+'" target="_blank" rel="noopener">'+item.link.label+'</a>'; }

    function botReply(raw){
      const msg = raw.toLowerCase();
      if (/\b(ktp|e-?ktp)\b/.test(msg)) return formatKB(kb.ktp);
      if (/\b(kk|kartu keluarga)\b/.test(msg)) return formatKB(kb.kk);
      if (/\b(sim)\b/.test(msg)) return formatKB(kb.sim);
      if (/\b(bpjs)\b/.test(msg)) return formatKB(kb.bpjs);
      if (/\b(nikah|pernikahan)\b/.test(msg)) return formatKB(kb.nikah);
      if (/\b(cerai|perceraian)\b/.test(msg)) return formatKB(kb.cerai);
      if (/\b(halo|hi|hai)\b/.test(msg)) return 'Halo, saya Lisa. Bisa bantu tentang KTP, KK, SIM, BPJS, nikah, atau cerai.';
      return 'Maaf, saya belum paham. Coba: "syarat KTP" atau "cara buat SIM".';
    }

    // minimal TTS (Indonesia only) â€” keep previous polling approach but lightweight
    let voiceEnabled = true;
    let voices = [];
    let selectedVoice = null;
    function populateIndoVoices(){
      voiceSelect.innerHTML = '';
      const idVoices = voices.filter(v=>v.lang && /(^|-)id($|[-_])/i.test(v.lang));
      if (!idVoices.length){ voiceSelect.innerHTML = '<option value="-1">Tidak ada suara Indonesia</option>'; voiceSelect.disabled=true; selectedVoice=null; return; }
      idVoices.forEach(v=>{
        const i = voices.indexOf(v);
        const opt = document.createElement('option');
        opt.value = i; opt.textContent = v.name + ' ('+v.lang+')'; voiceSelect.appendChild(opt);
      });
      voiceSelect.disabled=false;
      selectedVoice = voices[parseInt(voiceSelect.value,10)] || idVoices[0];
    }
    function loadVoices(){ voices = (speechSynthesis && speechSynthesis.getVoices()) || []; populateIndoVoices(); }
    if ('speechSynthesis' in window){ loadVoices(); speechSynthesis.onvoiceschanged = loadVoices; setTimeout(loadVoices,500); } else { voiceSelect.innerHTML='<option>Unavailable</option>'; voiceSelect.disabled=true; voiceToggle.disabled=true; }
    voiceToggle.addEventListener('click', ()=>{ voiceEnabled = !voiceEnabled; voiceToggle.textContent = voiceEnabled ? 'ðŸ”Š' : 'ðŸ”‡'; });
    voiceSelect.addEventListener('change', ()=>{ const idx = parseInt(voiceSelect.value,10); selectedVoice = Number.isFinite(idx)&&idx>=0 ? voices[idx] : null; });

    function speak(text){
      if (!voiceEnabled || !('speechSynthesis' in window) || !text) return;
      speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      if (selectedVoice) u.voice = selectedVoice;
      u.lang = selectedVoice?.lang || 'id-ID';
      u.rate = 1; u.pitch = 1;
      speechSynthesis.speak(u);
    }

    // initial welcome
    appendMessage('Halo, saya Lisa. Bisa bantu tentang KTP, KK, SIM, BPJS, nikah, atau cerai.');

    // send logic
    function handleSend(){
      const text = inputEl.value.trim();
      if (!text) return;
      appendMessage(escapeHtml(text), 'user');
      inputEl.value = '';
      appendMessage('<em>Lisa sedang mengetik...</em>', 'bot');
      setTimeout(()=>{
        const bots = messagesEl.querySelectorAll('.bot');
        if (bots.length){ const last = bots[bots.length-1]; if (last && /sedang mengetik/.test(last.textContent)) last.remove(); }
        const reply = botReply(text);
        appendMessage(reply, 'bot');
        // speak the reply
        speak(stripHtml(reply));
      }, 600);
    }

    sendBtn.addEventListener('click', handleSend);
    inputEl.addEventListener('keydown', e => { if (e.key === 'Enter') handleSend(); });

    // scroll helpers to keep input visible on mobile keyboards
    inputEl.addEventListener('focus', ()=> setTimeout(()=> messagesEl.scrollTop = messagesEl.scrollHeight, 300));
    window.addEventListener('resize', ()=> setTimeout(()=> messagesEl.scrollTop = messagesEl.scrollHeight, 200));
    window.addEventListener('orientationchange', ()=> setTimeout(()=> messagesEl.scrollTop = messagesEl.scrollHeight, 300));
  </script>
</body>
</html>
