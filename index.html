<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover" />
  <title>Ciptomulyo â€” Asisten Informasi</title>
  <style>
    :root {
      --bg: #f2f6fb;
      --card: #ffffff;
      --primary: #0b63d6;
      --muted: #7a8aa6;
      --bot-bg: #f1f4f8;
      --user-bg: #e6f0ff;
      --header-h: 68px;
      --footer-h: 70px;
      --max-w: 820px;
      --border-radius: 18px;
    }
    html, body {
      height: 100%;
      margin: 0;
      background: var(--bg);
      font-family: 'Inter', 'Segoe UI', 'Roboto', Arial, sans-serif;
      color: #0b2b45;
      -webkit-font-smoothing: antialiased;
    }
    .wrap {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 6px;
      box-sizing: border-box;
    }
    .chat {
      width: 100%;
      max-width: var(--max-w);
      height: 100vh;
      min-height: 500px;
      display: flex;
      flex-direction: column;
      background: linear-gradient(180deg, var(--card), #f2f8ff 60%, #e6f2fc 100%);
      border-radius: var(--border-radius);
      box-shadow: 0 8px 30px rgba(3, 20, 45, 0.07);
      overflow: hidden;
      border: 1px solid rgba(11,99,214,0.05);
      position: relative;
      margin: 0 auto;
    }
    .chat-logo-bg {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 70%;
      height: auto;
      z-index: 1;
      opacity: 0.2;
      pointer-events: none;
      background: none;
      display: block;
    }
    .chat-logo-bg img {
      width: 100%;
      max-width: 200px;
      height: auto;
      user-drag: none;
      user-select: none;
      display: block;
      margin: auto;
      pointer-events: none;
    }
    .messages {
      padding: 10px 7px 10px 7px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      overflow-y: auto;
      background: transparent;
      flex: 1 1 auto;
      z-index: 2;
      position: relative;
      scroll-behavior: smooth;
    }
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 10px 10px 9px 10px;
      background: linear-gradient(90deg, var(--primary), #0a56c0);
      color: #fff;
      position: sticky;
      top: 0;
      z-index: 5;
      min-height: var(--header-h);
      border-bottom: 1px solid #e3eaf3;
      flex-wrap: wrap;
    }
    .brand {
      display: flex;
      gap: 11px;
      align-items: center;
      min-width: 0;
    }
    .logo {
      width: 40px;
      height: 40px;
      border-radius: 11px;
      background: rgba(255,255,255,0.15);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 18px;
      flex: 0 0 auto;
      padding: 0;
      overflow: hidden;
    }
    .logo img {
      max-width: 32px;
      max-height: 32px;
      width: auto;
      height: auto;
      border-radius: 8px;
      background: transparent;
      user-select: none;
      user-drag: none;
      pointer-events: none;
      margin: 0;
      display: block;
    }
    .title {
      font-weight: 600;
      white-space: normal;
      font-size: 17px;
      line-height: 1.2;
      margin-bottom: 2px;
    }
    .subtitle {
      font-size: 12.5px;
      opacity: .98;
      color: rgba(255,255,255,0.93);
      white-space: normal;
      font-weight: 400;
      letter-spacing: 0.03em;
    }
    .controls {
      display: flex;
      gap: 8px;
      align-items: center;
      flex: 0 0 auto;
    }
    .mute {
      background: rgba(255,255,255,0.13);
      padding: 9px 11px;
      border-radius: 9px;
      color: #fff;
      cursor: pointer;
      border: 1px solid rgba(255,255,255,0.08);
      font-size: 18px;
    }
    select#voiceSelect {
      background: transparent;
      color: #fff;
      border: none;
      outline: none;
      padding: 7px 12px;
      border-radius: 7px;
      min-width: 140px;
      font-size: 14px;
    }
    select#voiceSelect, select#voiceSelect option { color: #fff; -webkit-text-fill-color:#fff; }
    .msg {
      max-width: 92%;
      padding: 13px 13px 13px 14px;
      border-radius: 13px;
      line-height: 1.45;
      word-break: break-word;
      font-size: 15.2px;
      box-shadow: 0 1px 3px #eff2ff10;
    }
    .bot {
      align-self: flex-start;
      background: var(--bot-bg);
      color: #07203b;
    }
    .user {
      align-self: flex-end;
      background: var(--user-bg);
      color: #032b57;
    }
    .footer {
      padding: 10px 8px;
      display: flex;
      gap: 8px;
      align-items: center;
      border-top: 1px solid rgba(10,20,40,0.05);
      background: linear-gradient(180deg,transparent,rgba(250,252,255,0.6));
      position: sticky;
      bottom: 0;
      z-index: 6;
      min-height: var(--footer-h);
      box-sizing: border-box;
    }
    .inputWrap {
      display: flex;
      gap: 8px;
      flex: 1;
      align-items: stretch;
      min-width: 0;
    }
    input[type="text"] {
      flex: 1;
      padding: 14px 15px;
      border-radius: 12px;
      border: 1px solid #dde6f8;
      background: #fff;
      font-size: 16.2px;
      outline: none;
      box-shadow: 0 2px 6px #144d9a0a;
      min-width: 0;
      transition: border 0.18s;
      height: 44px;
    }
    input[type="text"]:focus {
      border-color: #8abafd;
    }
    button.send {
      background: var(--primary);
      color: #fff;
      border: none;
      padding: 0 23px;
      font-size: 17px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      height: 44px;
      min-width: 70px;
      transition: background 0.18s;
    }
    button.send:active { background: #084fa0; }
    .quick {
      background: #e5f1ff;
      border: 1px solid #aed3fc;
      color: var(--primary);
      padding: 10px 13px;
      border-radius: 7px;
      margin: 8px 8px 0 0;
      cursor: pointer;
      font-size: 15px;
      display: inline-block;
      font-weight: 500;
      line-height: 1.1;
      user-select: none;
      white-space: nowrap;
      box-shadow: 0 1.5px 8px #3e71c208;
    }
    .quick:active { background: #d7ebfd; }

    /* Smartphone Layout Fixes */
    @media (max-width: 900px) {
      .chat { min-width: unset; min-height: 100vh; }
    }
    @media (max-width: 600px) {
      .chat {
        height: 100dvh;
        border-radius: 9px;
        min-width: unset;
        min-height: 100dvh;
      }
      .header {
        padding: 11px 7px 7px 7px;
        gap: 6px;
      }
      .messages { padding: 7px 2.5vw 7px 2.5vw; gap: 7.5px; }
      .brand { gap: 8px; }
      .logo { width: 35px; height: 35px; }
      .logo img { max-width: 25px; max-height: 25px; }
      .title { font-size: 15.5px; }
      .subtitle { font-size: 11.9px;}
      .msg { font-size: 14.5px; border-radius: 10px; padding: 11px 9px 11px 11px;}
      .footer { padding: 8px 4px; min-height: 58px; }
      .inputWrap { gap: 5px;}
      input[type="text"] { padding: 10px 12px; font-size: 15.1px; height: 40px; }
      button.send {padding: 0 15px; font-size: 15px; height: 40px; min-width: 48px;}
      .quick { font-size: 13px; padding: 8px 10px; margin: 6px 6px 0 0; }
      .chat-logo-bg img { max-width: 85px; }
    }
    @media (max-width:390px){
      .header { flex-direction: column; align-items: flex-start;}
      .brand { flex-direction: row; }
    }
    button:focus, select:focus, input:focus { outline: 2.5px solid #9fd3ff; outline-offset: 1px; }
  </style>
</head>
<body>
  <div class="wrap">
    <main class="chat" role="application" aria-label="Ciptomulyo - Asisten Informasi">
      <div class="chat-logo-bg">
        <img src="logo1.jpg" alt="Logo Ciptomulyo Bot" draggable="false" decoding="async" />
      </div>
      <header class="header">
        <div class="brand">
          <div class="logo" aria-hidden="true"><img src="logo2.jpg" alt="Logo Ciptomulyo" /></div>
          <div style="min-width:0">
            <div class="title">Ciptomulyo â€” Asisten Informasi</div>
            <div class="subtitle">BPJS, Surat Pengantar Nikah, SKTM, SKU, Waris, Surat Keterangan</div>
          </div>
        </div>
        <div class="controls" aria-hidden="false">
          <button id="voiceToggle" class="mute" title="Suara: aktif/nonaktif">ðŸ”Š</button>
          <select id="voiceSelect" aria-label="Pilih suara" title="Pilih suara"><option>Memuat suara ID...</option></select>
        </div>
      </header>
      <section id="messages" class="messages" aria-live="polite"></section>
      <form id="form" class="footer" onsubmit="return false;">
        <div class="inputWrap">
          <input id="input" type="text" placeholder="Tanya: BPJS, Surat Pengantar Nikah, Surat Keterangan Tidak Mampu, SKU, Waris ..." autocomplete="off" />
        </div>
        <button id="send" class="send" aria-label="Kirim pesan">Kirim</button>
      </form>
    </main>
  </div>
  <script>
    const messagesEl = document.getElementById('messages');
    const inputEl = document.getElementById('input');
    const sendBtn = document.getElementById('send');
    const voiceToggle = document.getElementById('voiceToggle');
    const voiceSelect = document.getElementById('voiceSelect');

    function escapeHtml(s){ return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
    function stripHtml(html){ const tmp = document.createElement('div'); tmp.innerHTML = html; return tmp.textContent || tmp.innerText || ''; }
    function appendMessage(html, who='bot'){
      const div = document.createElement('div');
      div.className = 'msg ' + (who==='user' ? 'user' : 'bot');
      div.innerHTML = html;
      messagesEl.appendChild(div);
      setTimeout(()=>{ messagesEl.scrollTop = messagesEl.scrollHeight; }, 10);
    }

    // Kata kunci utama/cepat
    const quickKeywords = [
      {label:'BPJS', trigger:'bpjs'},
      {label:'Surat Pengantar Nikah', trigger:'pengantar nikah'},
      {label:'Surat Keterangan Tidak Mampu', trigger:'surat keterangan tidak mampu'},
      {label:'SKU', trigger:'sku'},
      {label:'Surat Keterangan Waris', trigger:'surat keterangan waris'},
      {label:'Surat Keterangan Umum', trigger:'surat keterangan umum'}
    ];
    const simpleKeywords = quickKeywords.map(k=>k.trigger.toLowerCase());

    // Knowledge base per syarat/jawaban
    const kb = {
      bpjs:{
        title:'BPJS Kesehatan',
        text: `Persyaratan BPJS:<br>
          â€¢ KTP<br>
          â€¢ KK<br>
          â€¢ Surat Keterangan Tidak Mampu (SKTM) dari Kelurahan<br>
          â€¢ Pas foto 3x4<br>
          â€¢ Formulir Pendaftaran dari Kelurahan<br>
          <br>Untuk info lebih lanjut silahkan datang ke Kelurahan Ciptomulyo.`
      },
      nikah:{
        title:'Pendaftaran Nikah',
        text:'Untuk muslim daftar di KUA; non-muslim di catatan sipil.<br>Persyaratan: KTP, KK, akta kelahiran.<br><br>Untuk info lebih lanjut silahkan datang ke Kelurahan Ciptomulyo.'
      },
      cerai:{
        title:'Perceraian',
        text:'Ajukan ke Pengadilan Agama (muslim) atau Pengadilan Negeri (non-muslim).<br>Dokumen: akta nikah, KTP.<br><br>Untuk info lebih lanjut silahkan datang ke Kelurahan Ciptomulyo.'
      },
      pengantarnikah: {
        title: "Surat Pengantar Nikah",
        text: `<strong>PERSYARATAN ADMINISTRASI:</strong><br>
          â€¢ Surat pengantar RT/RW<br>
          â€¢ Fotokopi KK &amp; KTP pemohon, akta kelahiran kedua calon mempelai<br>
          â€¢ Foto background biru ukuran 3x4<br>
        <strong>ALUR PELAYANAN:</strong><br>
          â€¢ Pemohon datang ke Kelurahan membawa persyaratan<br>
          â€¢ Petugas membantu membuatkan form NI dan N4 pengantar nikah yang ditanda tangani oleh Lurah<br>
          â€¢ Setelah selesai, pemohon sudah dapat membawa surat ke KUA<br><br>
          Untuk info lebih lanjut silahkan datang ke Kelurahan Ciptomulyo.`
      },
      suratketerangantidakmampu: {
        title: "Surat Keterangan Tidak Mampu",
        text: `<strong>PERSYARATAN ADMINISTRASI:</strong><br>
          â€¢ Surat pengantar RT/RW<br>
          â€¢ Fotokopi KK &amp; KTP pemohon, akta kelahiran<br>
          â€¢ Surat pernyataan bermaterai 10.000<br>
        <strong>ALUR PELAYANAN:</strong><br>
          â€¢ Pemohon datang ke Kelurahan membawa persyaratan<br>
          â€¢ Petugas membantu membuatkan surat yang ditandatangani Lurah<br>
          â€¢ Setelah selesai, pemohon sudah dapat membawa surat ke tujuan<br><br>
          Untuk info lebih lanjut silahkan datang ke Kelurahan Ciptomulyo.`
      },
      sku: {
        title: "Surat Keterangan Usaha",
        text: `<strong>PERSYARATAN ADMINISTRASI:</strong><br>
          â€¢ Surat pengantar RT/RW<br>
          â€¢ Fotokopi KK &amp; KTP pemohon<br>
          â€¢ Foto tempat usaha<br>
        <strong>ALUR PELAYANAN:</strong><br>
          â€¢ Pemohon datang ke Kelurahan membawa persyaratan<br>
          â€¢ Petugas membantu membuatkan surat yang ditandatangani Lurah<br>
          â€¢ Setelah selesai, pemohon sudah dapat membawa surat ke tujuan<br><br>
          Untuk info lebih lanjut silahkan datang ke Kelurahan Ciptomulyo.`
      },
      suratketeranganwaris: {
        title: "Surat Keterangan Waris",
        text: `<strong>PERSYARATAN ADMINISTRASI:</strong><br>
          â€¢ Surat pengantar RT/RW<br>
          â€¢ Fotokopi KK &amp; KTP seluruh ahli waris<br>
          â€¢ Fotokopi objek waris<br>
        <strong>ALUR PELAYANAN:</strong><br>
          â€¢ Pemohon datang ke Kelurahan membawa persyaratan<br>
          â€¢ Petugas membantu membuatkan surat keterangan ahli waris<br>
          â€¢ Pemohon dan seluruh ahli waris menandatangani surat & terdokumentasi foto<br>
          â€¢ Berkas dicek dan ditandatangani Lurah<br>
          â€¢ Selanjutnya pemohon dapat membawa ke Kecamatan<br><br>
          Untuk info lebih lanjut silahkan datang ke Kelurahan Ciptomulyo.`
      },
      suratketeranganumum: {
        title: "Surat Keterangan Umum",
        text: `<strong>PERSYARATAN ADMINISTRASI:</strong><br>
          â€¢ Surat pengantar RT/RW<br>
          â€¢ Fotokopi KK &amp; KTP pemohon<br>
        <strong>ALUR PELAYANAN:</strong><br>
          â€¢ Pemohon datang ke Kelurahan membawa persyaratan<br>
          â€¢ Petugas membantu membuatkan surat dan ditandatangani oleh Lurah<br>
          â€¢ Setelah selesai, pemohon sudah dapat mengambil surat<br><br>
          Untuk info lebih lanjut silahkan datang ke Kelurahan Ciptomulyo.`
      }
    };

    function formatKB(item){
      return '<strong>'+item.title+'</strong><br>'+item.text;
    }
    // Otomatis kirim ulang keyword jika klik
    function quickSend(kw){
      inputEl.value = kw;
      handleSend();
    }

    // fallback jika tidak paham, beri saran keyword
    function suggestionMsg(){
      let html = 'Maaf, Ciptomulyo belum paham. Silahkan pilih kata kunci berikut:<br>';
      quickKeywords.forEach(k=>{
        html += `<span class="quick" onclick="quickSend('${k.trigger.replace(/'/g,"&apos;")}')">${k.label}</span> `;
      });
      html += '<br><br>Untuk info lebih lanjut silahkan datang ke Kelurahan Ciptomulyo.';
      return html;
    }

    window.quickSend = quickSend;

    // Balasan utama
    function botReply(raw){
      const msg = raw.toLowerCase();
      if (/pengantar.*nikah/.test(msg) || /\bpengantar nikah\b/.test(msg)) return formatKB(kb.pengantarnikah);
      if (/tidak.?mampu/.test(msg) || /\bsktm\b/.test(msg) || /surat keterangan tidak mampu/.test(msg)) return formatKB(kb.suratketerangantidakmampu);
      if (/keterangan.*umum/.test(msg) || /\bsurat umum\b/.test(msg) || /\bketerangan umum\b/.test(msg) || /surat keterangan umum/.test(msg)) return formatKB(kb.suratketeranganumum);
      if (/sku/.test(msg) || (/usaha/.test(msg) && /surat|keterangan/.test(msg)) || /surat keterangan usaha/.test(msg)) return formatKB(kb.sku);
      if (/waris/.test(msg) || /surat keterangan waris/.test(msg)) return formatKB(kb.suratketeranganwaris);
      if (/bpjs\b/.test(msg)) return formatKB(kb.bpjs);
      // Nikah pendaftaran tetap ada untuk pertanyaan umum
      if (/\b(nikah|pernikahan)\b/.test(msg)) return formatKB(kb.nikah);
      // Cerai tetap bisa dijawab jika ada yang bertanya, tapi tidak muncul di daftar quick keyword
      if (/\b(cerai|perceraian)\b/.test(msg)) return formatKB(kb.cerai);
      if (/\b(halo|hi|hai)\b/.test(msg))
        return 'Halo, saya Ciptomulyo. Bisa bantu tentang BPJS, Surat Pengantar Nikah, SKTM, SKU, Waris, dan berbagai surat keterangan kelurahan.';
      // typo minimal correction: sarankan keyword kalau salah ketik
      let inputWords = msg.split(/[\s.,]+/);
      let closeMatches = simpleKeywords.filter(kw=>
        inputWords.some(iw => kw.includes(iw) || iw.includes(kw) || levenshtein(kw, iw)<=3)
      );
      if (closeMatches.length) {
        return `Maksud Anda: ${closeMatches.map(c=>`<span class="quick" onclick="quickSend('${c}')">${c}</span>`).join(' ')} ?<br><br>Untuk info lebih lanjut silahkan datang ke Kelurahan Ciptomulyo.`;
      }
      // Fallback selalu tampilkan daftar
      return suggestionMsg();
    }
    // Levenshtein (untuk toleransi typo)
    function levenshtein(a, b) {
      if (a === b) return 0;
      if (!a.length) return b.length;
      if (!b.length) return a.length;
      let v0 = new Array(b.length + 1).fill(0);
      let v1 = new Array(b.length + 1).fill(0);
      for (let i = 0; i < v0.length; i++) v0[i] = i;
      for (let i = 0; i < a.length; i++) {
        v1[0] = i + 1;
        for (let j = 0; j < b.length; j++) {
          let cost = a[i] === b[j] ? 0 : 1;
          v1[j + 1] = Math.min(v1[j] + 1, v0[j + 1] + 1, v0[j] + cost);
        }
        let tmp = v0; v0 = v1; v1 = tmp;
      }
      return v0[b.length];
    }
    // Voice
    let voiceEnabled = true;
    let voices = [];
    let selectedVoice = null;
    function populateIndoVoices(){
      voiceSelect.innerHTML = '';
      const idVoices = voices.filter(v=>v.lang && /(^|-)id($|[-_])/i.test(v.lang));
      if (!idVoices.length){ voiceSelect.innerHTML = '<option value="-1">Tidak ada suara Indonesia</option>'; voiceSelect.disabled=true; selectedVoice=null; return; }
      idVoices.forEach(v=>{
        const i = voices.indexOf(v);
        const opt = document.createElement('option');
        opt.value = i; opt.textContent = v.name + ' ('+v.lang+')'; voiceSelect.appendChild(opt);
      });
      voiceSelect.disabled=false;
      selectedVoice = voices[parseInt(voiceSelect.value,10)] || idVoices[0];
    }
    function loadVoices(){ voices = (speechSynthesis && speechSynthesis.getVoices()) || []; populateIndoVoices(); }
    if ('speechSynthesis' in window){ loadVoices(); speechSynthesis.onvoiceschanged = loadVoices; setTimeout(loadVoices,500); } else { voiceSelect.innerHTML='<option>Unavailable</option>'; voiceSelect.disabled=true; }
    voiceToggle.addEventListener('click', ()=>{ voiceEnabled = !voiceEnabled; voiceToggle.textContent = voiceEnabled ? 'ðŸ”Š' : 'ðŸ”‡'; });
    voiceSelect.addEventListener('change', ()=>{ const idx = parseInt(voiceSelect.value,10); selectedVoice = Number.isFinite(idx)&&idx>=0 ? voices[idx] : null; });

    function speak(text){
      if (!voiceEnabled || !('speechSynthesis' in window) || !text) return;
      speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      if (selectedVoice) u.voice = selectedVoice;
      u.lang = selectedVoice?.lang || 'id-ID';
      u.rate = 1; u.pitch = 1;
      speechSynthesis.speak(u);
    }

    // SAPAAN AWAL (TANPA KALIMAT PENUTUP)
    appendMessage('Halo, saya Ciptomulyo. Bisa bantu tentang BPJS, Surat Pengantar Nikah, SKTM, SKU, Waris, dan berbagai surat keterangan kelurahan.');

    function handleSend(){
      const text = inputEl.value.trim();
      if (!text) return;
      appendMessage(escapeHtml(text), 'user');
      inputEl.value = '';
      appendMessage('<em>Ciptomulyo sedang mengetik...</em>', 'bot');
      setTimeout(()=>{
        const bots = messagesEl.querySelectorAll('.bot');
        if (bots.length){ const last = bots[bots.length-1]; if (last && /sedang mengetik/.test(last.textContent)) last.remove(); }
        const reply = botReply(text);
        appendMessage(reply, 'bot');
        speak(stripHtml(reply));
      }, 550);
    }
    sendBtn.addEventListener('click', handleSend);
    inputEl.addEventListener('keydown', e => { if (e.key === 'Enter') handleSend(); });

    // scroll helpers to keep input visible on mobile
    inputEl.addEventListener('focus', ()=> setTimeout(()=> messagesEl.scrollTop = messagesEl.scrollHeight, 200));
    window.addEventListener('resize', ()=> setTimeout(()=> messagesEl.scrollTop = messagesEl.scrollHeight, 140));
    window.addEventListener('orientationchange', ()=> setTimeout(()=> messagesEl.scrollTop = messagesEl.scrollHeight, 200));
  </script>
</body>
</html>
